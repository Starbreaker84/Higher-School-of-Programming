## Репликация без ведущего узла

Все рассмотренные репликации основаны на принципе, что клиент отправляет запрос на запись некоторому ведущему узлу, а СУБД берет на себя дублирование этой операции на всех остальных репликах. Ведущий узел определяет порядок обработки операций записи, а ведомые узлы применяют полученные от ведущего узла операции записи в том же порядке.

Amazon задействовал новую (точнее, хорошо забытую старую) архитектуру для системы Dynamo, после чего эта архитектура была реализована в системах Riak, Cassandra и Voldemort. В ней больше не существуют ведущие узлы, и  **информация об операциях записи поступает непосредственно сразу на все реплики** .

Более "слабые" версии такой архитектуры подразумевают, что клиент отправляет информацию о своих операциях записи на несколько реплик (не все), а для остальных реплик данную операцию от имени клиента осуществляет специальный узел-координатор.

Крайне принципиальный момент данной архитектуры --  **отказ от навязывания определённого порядка операций записи** .


## Репликация без ведущего узла

Проблема 45. Пусть в проекте с поддержкой схемы репликации с ведущим узлом имеется БД с тремя репликами, одна из которых стала недоступной (например, перезагружается для установки обновлений). В таком случае придется явно выполнить её восстановление после отказа, что усложняет техническое сопровождение и ухудшает общую надёжность системы.

Решение. Использовать схему репликации без ведущего узла. Клиент отправляет информацию об операции записи параллельно всем трём репликам, и две доступные реплики принимают её, а недоступная -- нет. Тут используются  **схемы подтверждения большинством реплик** : вполне достаточно, чтобы две из трёх реплик подтвердили получение операции записи. Клиент в таком случае просто игнорирует тот факт, что одна из реплик не получила информацию.


## Репликация без ведущего узла

Проблема 46. Бывший недоступным узел снова ожил и заработал, и клиенты начинают снова читать из него данные. Но в нём отсутствует информация обо всех операциях записи, поступивших, когда он не функционировал. Следовательно, при чтении из него клиенты рискуют получить устаревшие значения.

Решение. Использовать для чтения ту же схему подтверждения большинством реплик, как и при записи: клиенты отправляют запросы не к одной реплике, а сразу к нескольким узлам параллельно. При этом клиент может получить различные ответы от разных узлов -- актуальные значения от одного узла и устаревшие от другого. А чтобы определить, какое значение новее, используются номера версий операций записи, или простое большинство одинаковых ответов (но это сложнее в реализации на клиенте и в общем случае не гарантирует корректности, если в системе был масштабный сбой, и большая часть узлов не работала).


## Репликация без ведущего узла

Проблема 47. Схема репликации должна обеспечивать копирование в конечном итоге всех без исключения данных в каждую без исключения реплику. Каким образом ранее недоступный узел после возобновления работы может продуктивно наверстать пропущенные им операции записи?

Решение. В хранилищах данных наподобие Amazon Dynamo часто используются два механизма.

1) **Разрешение конфликтов при чтении** . Клиент, читающий данные с нескольких узлов параллельно, способен обнаружить все устаревшие ответы.
2) **Процесс снижения энтропии** . Запускается фоновый процесс (anti-entropy process), который постоянно выискивает различия в данных между репликами и копирует недостающие данные из одной реплики в другую. Его работа отличается от поддержки журнала репликации при репликации с ведущим узлом в том, что информация об операциях записи не реплицируется в каком-то определённом порядке, и до копирования (синхронизации) актуальных данных таким процессом может пройти непредсказуемо много времени.



### Репликация без ведущего узла (задания)

======= 39. Репликация без ведущего узла -- это ... (выберите неверный ответ)

[ ] клиент отправляет информацию о своих операциях записи на несколько реплик (не все)

[ ] СУБД обеспечивает дублирование операций записи на всех репликах

[ ] информация об операциях записи поступает сразу на все реплики

[ ] отказываемся от определённого порядка операций записи

======= 40. В репликации без ведущего узла применяется ...

[ ] схема подтверждения ведущей репликой

[ ] схема подтверждения несколькими избранными репликами

[ ] схема подтверждения большинством реплик

======= 41. Как ранее недоступному узлу после сбоя продуктивно восстановиться? (выберите неверный ответ)

[ ] использовать журнал репликации, как в случае с ведущим узлом

[ ] запускается фоновый anti-entropy process

[ ] клиент обнаруживает устаревшие ответы
