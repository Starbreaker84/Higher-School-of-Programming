### Запись в столбцовое хранилище

В хранилищах данных допускаются различные формы оптимизации, так как большая часть нагрузки приходится на выполняемые аналитиками объёмные запросы, предназначенные только для чтения данных. Столбцовое хранение, сжатие и сортировка хорошо ускоряют выполнение таких запросов. Однако у хранилищ имеется серьёзный недостаток в виде  **усложнения операций записи** .

Подход с обновлением данных на месте, используемый B-деревьями, невозможен в случае сжатых столбцов. При необходимости вставить строки в середину отсортированной таблицы, вероятнее всего, придется переписать все файлы столбцов. Вставка должна обновлять все столбцы согласованным образом -- ведь строки определяются по их позиции в столбце.

К счастью, ранее мы уже изучили хорошее решение этой проблемы: LSM-деревья. Всё записывается сначала в хранилище в оперативной памяти, где данные добавляются в отсортированную структуру и подготавливаются к записи на диск.

Не имеет значения, будет ли хранилище в оперативной памяти столбцовым или построчным. При накоплении достаточного количества записываемых данных они объединяются с файлами столбцов на диске и записываются блоками в новые файлы.


### Пропускная способность памяти и векторизованная обработка

Существенно узким местом для запросов к хранилищам данных, которым приходится просматривать миллионы и миллиарды строк, становится пропускная способность перемещения данных из диска в память. Кроме того, проблемой аналитических БД будет эффективное использование скорости передачи данных из оперативной памяти в кэш процессора, избегание разными способами ошибочного прогнозирования ветвей и «пузырьков» в конвейере обработки инструкций CPU, а также применение векторных инструкций (single-instruction-multi-data, SIMD) современных процессоров.

Помимо снижения объёмов загружаемых с диска данных, столбцовые схемы хранилищ также могут эффективно использовать циклы процессора. Например, подсистема обработки запросов может взять порцию данных, которая хорошо помещается в L1-кэше процессора, и проходить по ней в сплошном цикле (то есть без вызовов функций). Процессор способен выполнять такой цикл намного быстрее, нежели код, содержащий множество вызовов функций и условий для каждой обрабатываемой записи. Сжатие столбцов позволяет поместить в том же объеме L1-кэша гораздо больше строк для одного столбца. Для работы напрямую с такими порциями сжатых столбцовых данных можно задействовать например кллассические побитовые операции OR/AND. Этот метод известен под названием  **векторизованной обработки** .


## Столбцовое хранилище (задания)

======= 76. Запись в хранилище данных ...

[ ] быстрее чем в реляционных СУБД, потому что столбцы сжаты и компактны

[ ] быстрее чем в реляционных СУБД, потому что столбцы надо обновлять согласованно

[ 1] медленнее чем в реляционных СУБД, потому что столбцы надо обновлять согласованно

[ ] медленнее чем в реляционных СУБД, потому что столбцы сжаты и компактны

======= 77. Ускорить запись в хранилищах данных можно ...

[ ] с помощью B-деревьев, обновлением на месте

[ ] с помощью B-деревьев, обновлением в памяти

[ 1] с помощью LSM-деревьев, обновлением в памяти

[ ] с помощью LSM-деревьев, обновлением на месте

======= 78. Ускорить запись в хранилищах данных можно ...
(выберите лишнее)

[ ] размещением данных в кэш процессора

[ ] побитовыми операциями

[ ] векторизованной обработкой

[ 1] оптимизацией функций и условий в машинном коде CPU
