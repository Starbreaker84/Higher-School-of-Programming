## Изоляция снимков состояния

Проблема 25. К сожалению, на данном уровне изоляции всё ещё существует немало потенциальных ошибок конкурентного доступа. Это прежде всего **невоспроизводимое чтение** (nonrepeatable read) или **асимметрия чтения** (read skew). Если например Оксана переводит 100 рублей с одного своего счёта на другой её же, то пока транзакция с операцией записи на второй счёт ещё выполняется, в балансе счётов возможно расхождение (с одного счёта сумма успешно списалась, а на другой ещё не поступила). Это ситуация довольно типична и для сегодняшнего дня: в онлайн-кабинетах довольно многих банков такое встречается регулярно.

Решение. Это временная проблема, и банки относятся к ней спокойно, потому что Оксана увидит согласованные балансы счетов, просто перезагрузив сайт онлайн-банкинга через несколько секунд или, в крайнем случае, минут.

## Изоляция снимков состояния

Проблема 26. В некоторых ситуациях временные несоответствия между состояниями недопустимы. Это, например, резервное копирование: на формирование копии всей базы данных в большой системе может уйти несколько часов. Однако операции записи в базу продолжают выполняться на всём протяжении создания резервной копии, и скорее всего окажется, что одни части резервной копии содержат старые версии данных, а другие -- новые. И тогда впоследствии, если из подобной копии выполнится восстановление БД, все такие расхождения (например, пропавшие деньги) станут постоянными.

Другая типичная проблемная ситуация -- аналитические запросы, которые просматривают значительные части базы данных. Они также могут быть частью периодической проверки целостности (мониторинг на предмет порчи данных). Если подобные запросы будут видеть разные части БД по состоянию на различные моменты времени, то их результаты будут совершенно бессмысленными.

Решение. Чаще всего используемое решение -- так называемая  **изоляция снимков состояния** . Идея состоит в том, что каждая транзакция читает данные из "согласованного" снимка состояния БД: видит данные, которые были успешно зафиксированы в базе на момент начала этой транзакции. Даже если данные затем будут изменены другой транзакцией, каждая транзакция видит только старые данные -- по состоянию на конкретный момент времени.

Изоляция снимков состояния поддерживается всеми популярными СУБД -- PostgreSQL, MySQL, Oracle, SQL Server и др.

## Изоляция снимков состояния

Изоляция снимков состояния обычно применяет блокировку записи для предотвращения "грязных" операций записи, однако операции чтения не требуют блокировок. Ключевой принцип изоляции снимков состояния:  **"чтение никогда не блокирует запись, а запись никогда не блокирует чтение"** . Благодаря этому база данных способна выполнять длительные запросы на чтение, продолжая в то же время обработку операций записи, без какой-либо конкуренции блокировок между ними.

Проблема 27. Различным выполняемым транзакциям может понадобиться состояние базы на самые разные моменты времени (так как неизвестно, какие транзакции отработают успешно, а какие прервутся).

Решение. СУБД приходится хранить одновременно несколько различных версий каждого объекта, обрабатываемого транзакциями. Такой подход получил название **многоверсионного управления конкурентным доступом** (multiversion concurrency control, MVCC).

На случай, если базе необходима только изоляция уровня чтения данных, но не уровень изоляции снимков состояния, достаточно хранить только две версии объекта: зафиксированную версию и перезаписанную, но ещё не зафиксированную версию.

Изоляция снимков состояния в разных СУБД называется по разному. Например, в Oracle это уровень сериализации (serializable), а в PostgreSQL и MySQL -- воспроизводимое чтение (repeatable read).

### "Грязные" операции чтения и записи (задания)

======= 19. "Грязная" транзакция чтения -- это ...

[ ] две транзакции читают одни и те же данные, мешая друг другу

[ ] две транзации одновременно меняют и читают данные

[ 1] одна транзакция читает данные, модифицируемые в этот момент другой транзакцией

======= 20. Базовый уровень гарантии изоляции транзакций -- это ...

[ ] поддержка блокировок объектов

[ ] ведение истории значений объектов

[ 1] никаких "грязных" операций чтения

======= 21. Как избежать ожидания длительной транзакции в режиме изоляции?

[ ] поддержка блокировок объектов

[ 1] ведение истории значений объектов

[ ] никаких "грязных" операций чтения

[ ] изоляция снимков состояния
