### 20. Агрегирование: кубы данных и материализованные представления

Не все хранилища данных для задач OLAP обязательно столбцовые: нередко используются и обычные построчные БД, а также несколько других архитектур. Однако столбцовые хранилища работают намного быстрее при произвольных аналитических запросах, так что их популярность быстро растет.

Другая важная особенность хранилищ данных:  **материализованные сводные показатели** . Запросы к хранилищам часто включают функции агрегирования (например, COUNT, SUM, AVG, MIN или MAX в языке SQL). Если во множестве различных запросов используются одни и те же функции агрегирования, то было бы расточительством каждый раз пересчитывать необработанные данные заново с нуля. Почему бы не кэшировать часть сводных показателей, применяемых в запросах чаще всего, если данные не менялись?

Один из способов создания подобного кэша --  **материализованное представление (materialized view)** . В реляционной модели данных оно часто описывается аналогично обычному (виртуальному) представлению: создаётся напоминающий таблицу объект, чьё содержимое является результатом какого-то запроса. Различие состоит в том, что материализованное представление является фактической копией результатов запроса, записанной на диск, в то время как виртуальное представление -- просто сокращенная форма записи для написания запросов. При чтении из виртуального представления движок SQL динамически разворачивает его в лежащий в его основе запрос, и затем полноценно выполняет этот развернутый запрос.


### OLAP-куб

В случае изменения данных, использованных в агрегированном запросе, необходимо обновить материализованное представление, поскольку оно представляет собой денормализованную копию этих данных. СУБД может выполнять обновления автоматически, но подобные манипуляции увеличивают стоимость операций записи, так что материализованные представления редко используются в базах данных OLTP. В хранилищах же, где основная нагрузка приходится на операции чтения, имеет смысл активно их применять. Улучшат ли они на самом деле производительность операций чтения, зависит от конкретного случая.

Распространенный случай материализованного представления --  **куб данных (data cube), или OLAP-куб (OLAP cube)** . Он представляет собой сетку сводных показателей, сгруппированных по различным измерениям. Например, у каждого факта в таблице фактов имеются внешние ключи только к двум таблицам измерений, допустим, дата и товар. Можно построить двумерную таблицу с товарами по одной оси координат, и датами по другой. Каждая ячейка содержит сводный показатель (например, SUM) атрибута (например, цены) всех фактов с таким сочетанием даты и товара. Затем можно применить ту же агрегирующую функцию вдоль каждой строки или столбца и получить итоги, сокращенные на одно измерение (продажи по товарам независимо от даты или продажи по датам независимо от товара).


В общем случае у фактов часто бывает больше двух измерений. Типичный пример: дата, товар, магазин, рекламная кампания и покупатель. Формально задать пятимерный гиперкуб намного сложнее, но идея остается той же самой: каждая ячейка содержит продажи для соответствующего сочетания даты, товара, магазина, рекламной кампании и покупателя. Эти значения можно затем последовательно группировать по каждому из измерений.

Преимущество материализованных кубов состоит в том, что определенные запросы будут выполняться очень быстро, поскольку данные для них были, по сути, заранее вычислены. Например, если нужно узнать общий объем продаж за вчера по каждому магазину, то достаточно просто посмотреть на итоги по соответствующему измерению -- нет никакой необходимости анализировать миллионы строк.

Недостаток же этого подхода заключается в том, что кубы данных не имеют такой гибкости, как запросы к исходным данным. Например, нельзя подсчитать, какая доля продаж приходится на товары, стоящие менее тысячи рублей, поскольку цена не используется в качестве одного из измерений, а увеличение количества измерений приводит к быстрому усложнению и увеличению объёма всей БД.


## Агрегирование (задания)

======= 79. Материализованное представление -- это ...

[ ] сокращённая форма запроса, записанная на диск

[1 ] условная временная таблица с результатами некоторого запроса

[ ] сокращённая форма запроса, вычисленная на лету

[ ] нормализованная копия данных

======= 80. OLAP-куб -- это сетка ...

[1] сводных показателей, сгруппированных по внешним ключам

[] сводных показателей, сгруппированных по фактам

[ ] сводных показателей, сгруппированных по агрегирующей функции

======= 81. OLAP-куб удобен, потому что ...

[1] запросы агрегирования выполняются очень быстро, но только по некоторым измерениям

[] запросы агрегирования выполняются по любым измерениям
