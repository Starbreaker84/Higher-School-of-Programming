### 19. Столбцовое хранилище

В типичном хранилище данных таблицы часто очень широкие: в таблицах фактов могут быть сотни столбцов. Таблицы измерений тоже могут быть очень широкими, так как включают много метаданных, которые требуются при анализе.

Если в таблицах фактов содержатся триллионы строк и петабайты данных, эффективное хранение и выполнение запросов к ним становится трудной задачей. Таблицы измерений обычно намного меньше (миллионы строк), так что мы сосредоточимся в основном на хранилищах фактов.

Хотя ширина таблиц фактов часто превышает 100 столбцов, типичный запрос к хранилищу обращается только буквально к единичным из них за раз (запросы типа "SELECT *" для анализа данных применяются редко).

В большинстве OLTP баз данных хранилище устроено построчно: все значения из одной строки таблицы хранятся рядом друг с другом. Документоориентированные БД устроены аналогично: весь документ обычно хранится в виде непрерывной последовательности байтов.

Но в таком случае реализованная построчно подсистема хранения должна загрузить все строки (каждая из которых состоит из более чем 100 атрибутов) с диска в оперативную память, выполнить их синтаксический разбор и отфильтровать не удовлетворяющие заданным условиям. На это может уйти много времени.

Поэтому возникла идея  **столбцовых хранилищ** , она проста: нужно хранить рядом значения не из одной строки, а из одного столбца. Если каждый столбец хранится например в отдельном файле, то запросу требуется только прочитать и выполнить синтаксический разбор необходимых столбцов.

Размещение данных по столбцам требует, чтобы файлы всех столбцов содержали строки в одинаковом порядке. Следовательно, при необходимости собрать воедино целую 23-ю строку, надо взять из всех файлов отдельных столбцов 23-й элемент и собрать их вместе для формирования 23-й строки таблицы.

Помимо загрузки с диска только тех столбцов, которые нужно для запроса, можно ещё более снизить требования к пропускной способности диска, сжав данные. К счастью, столбцовое хранилище часто очень хорошо поддаётся сжатию, так как в столбцах хранятся близкие по смыслу и часто похожие значения. В зависимости от содержащихся в столбце данных применяются различные методы сжатия. Один из методов, особенно эффективных при работе с хранилищами данных — кодирование с помощью битовой карты (принцип похож на фильтр Блюма).

### Порядок сортировки в столбцовом хранилище

В столбцовом хранилище порядок хранения строк может не иметь значения. Проще всего хранить строки в порядке их вставки в базу, ведь при этом вставка новой строки будет означать просто дописывание в конец всех файлов столбцов. Однако можно и явно задать какой-либо порядок -- аналогично SS-таблицам, и использовать его в качестве механизма индексации. Сортировать каждый столбец отдельно смысла нет, поскольку тогда не будет известно, какие элементы столбцов относятся к нужной строке. Мы сможем воссоздавать строки только потому, что знаем: k-й элемент одного столбца и k-й элемент другого столбца всегда соответствуют одной и той же k-й строке. Вместо этого необходимо сортировать сразу целые строки – «логически», несмотря на то, что данные хранятся по столбцам. Такая сортировка полезна, если можно выбрать конкретные столбцы, по которым требуется сортировать таблицу, основываясь на знаниях о том, какие запросы выполняются чаще всего. Или, например, второй столбец может определять порядок сортировки строк, значение которых в первом столбце одинаково.

Сортировка также хорошо помогает при сжатии столбцов. Если в основном столбце сортировки количество различных значений невелико, то после сортировки в нём появятся длинные последовательности повторяющихся одинаковых значений в строке. Простое кодирование, например, по схеме битовых карт, может сжать такой столбец буквально до нескольких килобайтов даже при наличии в таблице миллиардов строк. Сжатие лучше всего работает для первого ключа сортировки. Второй и третий ключи будут сильнее перемешаны, а следовательно, в них не будет таких длинных серий повторяющихся значений.

### Порядок сортировки в столбцовом хранилище - 2

Для различных запросов лучше подходят разные порядки сортировки, тогда почему бы не хранить одни и те же данные отсортированными несколькими различными способами (в виде нескольких копий)? Всё равно обычно приходится реплицировать данные по нескольким машинам во избежание их потери в случае сбоя одной из них. Вполне допустимо хранить эти избыточные данные отсортированными различными способами, чтобы при обработке запроса можно было использовать ту их версию, которая лучше всего подходит для конкретного запроса.

Наличие нескольких порядков сортировки в столбцовом хранилище напоминает группу вторичных индексов в построчном хранилище. Но важное различие состоит в том, что в построчном хранилище каждая строка хранится в одном месте (в неупорядоченном файле или кластеризованном индексе), и вторичные индексы лишь содержат указатели на соответствующие строки. В столбцовом хранилище же обычно нет никаких указателей на данные -- только столбцы, содержащие значения.


## Столбцовое хранилище (задания)

======= 73. В столбцовом хранилище по умолчанию ...

[ 1] каждый столбец хранится в порядке добавления

[ ] каждый столбец хранится в отсортированном порядке

[ ] каждый столбец хранится вместе с индексами

[ ] каждый столбец хранится в SS-таблице

======= 74. Столбцовое хранилище ...

[ 1] хорошо сжимается, так как в столбцах много похожих значений

[ ] плохо сжимается, так как столбцы хранятся в разных файлах

======= 75. Стобцы сортируются ...

[ ] одинаковыми способами, так как это помогает сжатию

[ ] одинаковыми способами, так как это упрощает поддержку вторичных индексов

[ ] одинаковыми способами для оптимизации под запросы

[ 1] разными способами для оптимизации под запросы

[ ] разными способами, так как это помогает сжатию
