### Перебалансировка секций

Проблема 73. С течением времени количество обрабатываемых запросов растёт, размер набора данных растёт, некоторые компьютеры начинают сбоить и т. п. Всё это требует перемещения данных и перенаправления запросов из одних узлов в другие.

Процесс перемещения нагрузки с одного узла в кластере на другой называется  **перебалансировкой (rebalancing)** . Вне зависимости от используемой схемы секционирования перебалансировка должна отвечать определенным минимальным требованиям:

- после перебалансировки нагрузка (хранение данных, запросы на чтение и запись) должна быть распределена равномерно по узлам кластера;
- во время перебалансировки база данных должна продолжать принимать запросы на чтение и на запись;
- между узлами должно перемещаться ровно то количество данных, которое необходимо -- ради ускорения перебалансировки и минимизации нагрузки по вводу/выводу на сеть и жёсткие диски.

Решение. Напрашивается применять хеширование ключей по модулю N узлов.


### Перебалансировка секций

Проблема 74. Проблема с методом по модулю N состоит в том, что при изменении количества N узлов придется перенести большинство ключей из одного узла в другой.

Решение. К счастью, существует очень простое решение: создать намного больше секций, чем узлов в системе, и распределить по нескольку секций на каждый узел. Например, разбить базу данных, работающую на кластере из десяти узлов, на 1000 секций из расчёта по 100 секций на каждый узел. Тогда добавляемый в кластер новый узел может позаимствовать на время по нескольку секций у каждого из существующих узлов, до тех пор пока секции не станут снова распределены равномерно.

Между узлами перемещаются только секции целиком. Количество секций не меняется, как и соответствие ключей секциям. Единственное, что изменяется -- это распределение секций по узлам. Перемещение значительного количества данных по сети занимает некоторое время, и для всех происходящих во время перемещения операций записи и чтения используется старое распределение секций.


### Перебалансировка секций

Проблема 75. Количество секций обычно задаётся при первой настройке базы данных и потом не меняется. Заданное вначале количество секций равно максимальному количеству возможных узлов, поэтому его рекомендуется выбирать достаточно большим для обеспечения возможности будущего роста. Однако каждая секция означает дополнительные накладные расходы на управление, вследствие чего выбирать слишком большое количество секций тоже неразумно.

Выбор правильного количества секций особенно сложен при сильной изменчивости общего размера набора данных (например, вначале он невелик, но может сильно вырасти со временем). Поскольку в каждой секции содержится фиксированная доля всех данных, размер секций растет пропорционально общему объему данных в кластере. При очень большом размере секций перебалансировка и восстановление после отказов узлов требуют значительных ресурсов. А слишком маленький размер секций приводит к слишком большим накладным расходам непосредственно в процессе работы системы.

Решение. Наилучшая производительность достигается при некотором оптимальном размере секций, когда они не слишком большие и не слишком маленькие, чего непросто добиться при фиксированном количестве секций и меняющемся размере набора данных.


### Перебалансировка секций (задания)

======= 62. Перебалансировка должна отвечать минимальным требованиям (выберите лишнее)

[ ] нагрузка должна в итоге равномерно распределиться по узлам

[ ] БД должна продолжать обрабатывать запросы на чтение и на запись

[ 1] нагрузка должна в итоге равномерно распределиться по секциям

[ ] между узлами должен перемещаться минимально требуемый объём данных

======= 63. При перебалансировке между узлами перемещаются ...

[1 ] секции целиком

[ ] секции по частям

[ ] первичные и вторичные индексы

======= 64. Размер секций желательно выбирать ...

[ ] большими

[ 1] не большими и не маленькими

[ ] маленькими
