## Предикатная блокировка

Пропускная способность СУБД по транзакциям и время отклика запросов значительно хуже при двухфазной блокировке, чем при слабой изоляции. Отчасти это связано с затратами на установку и освобождение всех блокировок, но в большей степени всё же вследствие снижения степени конкурентности.

Проблема 39. По определению, если две конкурентные транзакции пытаются произвести какие-либо действия, способные потенциально привести к состоянию гонки, одной из них придется ожидать завершения второй. В результате одна транзакция может ожидать другую неограниченное время. Фактически на практике достаточно всего одной медленно работающей транзакции, или всего одной транзакции, обращающейся к большому объёму данных и устанавливающей множество блокировок, чтобы вся остальная система сильно замедлилась вплоть до полной остановки.

Решение. **Предикатная блокировка** (predicate lock) аналогична изученным ранее разделяемым/монопольным блокировкам, но относится не к конкретному объекту (например, одной строке в таблице), а ко всем объектам, удовлетворяющим некоторому условию отбора. Но главное, что предикатные блокировки применимы даже к тем объектам, которые ещё не существуют в базе данных, но могут появиться в будущем (фантомы). Если двухфазная блокировка поддерживает и предикатные блокировки, то база данных предотвращает все формы асимметрии записи и других состояний гонки, и её изоляцию можно с полным правом назвать сериализуемостью.

## Предикатная блокировка

Проблема 40. Производительность предикатных блокировок в силу их сложности невысокая, и в случае большого количества блокировок от активных транзакций соответствующие предикатные проверки могут занимать значительное время.

Решение. На практике часто применяется **блокировка по диапазону значений индекса** (index-range lock), или блокировка следующего ключа (next-key locking). Это просто упрощенный аналог предикатной блокировки, когда предикат упрощается так, чтобы он легко вычислялся/проверялся и соответствовал более широкому множеству объектов. Такой подход обеспечивает эффективную защиту от фантомов и асимметрий записи. Блокировки по диапазону значений индекса не столь точны, как предикатные блокировки, так как блокируют более широкий диапазон объектов, чем необходимо для поддержания сериализуемости, но это хороший компромисс в плане используемых ресурсов.

### Двухфазная блокировка (задания)

======= 36. Двухфазная блокировка допускает конкурентное чтение одного объекта несколькими транзакциями ...

[ ] всегда

[ ] только если никто его не считывает

[1 ] только если никто его не записывает

======= 37. При двухфазной блокировке ...

[ ] читающие транзакции никогда не блокируют записывающие, а записывающие никогда не блокируют читающие

[ 1] читающие транзакции никогда не блокируют записывающие, а записывающие блокируют читающие

[ ] читающие транзакции блокируют записывающие, а записывающие никогда не блокируют читающие

[] читающие транзакции блокируют записывающие, а записывающие блокируют читающие

======= 38. Если возникает клинч (транзакция A ждет снятия блокировки транзакции B и наоборот)...

[ ] база данных обычно автоматически разрешает конфликт

[ 1] база данных автоматически прервёт одну из транзакций

[ ] приложению надо самому прерывать одну из транзакций
