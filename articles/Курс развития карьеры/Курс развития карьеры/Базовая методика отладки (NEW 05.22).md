## Базовая методика отладки и устранения багов

**1. Воспроизведите ошибку повторяемо.**

Этот момент, пожалуй, самый трудный, и связан больше с опытом и интуицией, нежели с логикой. Прежде всего вам необходимо последовательно воспроизвести ошибку, если вы хотите понять, что и где пошло не так. Однако невозможно рационально объяснить, как именно перейти от "я уже встречал эту ошибку дважды" к "я могу последовательно воспроизвести эту ошибку на своём компьютере локально".

**2. Воспроизведите ошибку быстро.**

Все также согласны с тем, что крайне полезно иметь возможность быстро воспроизвести ошибку -- иначе, если вам требуется по 5 минут, чтобы проверить, помогло ли очередное изменение кода, то это означает, что ваш рабочий цикл идёт ОЧЕНЬ медленно.

Несколько рекомендаций:

- если вы отлаживаете веб-систему, и баг воспроизводится длинной последовательностью пользовательских действий в UI, используйте сервисы записи и автоматизации действий (например, [Selenium](https://www.selenium.dev/)).
- напишите скрипт или найдите подходящую системную команду, которая смоделирует нужные действия (например, curl).
- (лучшее, но не всегда возможное) напишите юнит-тест, который повторяемо воспроизводит ошибку (бонус: добавьте его в общий набор тестов).

**3. Признайте, что виноват, скорее всего, ваш код.**

Я начал программировать в 1979-м, и с тех пор постоянно (!) встречаю жалобы программистов, что дескать в очередном странном баге виновато что угодно (ОС, фреймворк, библиотека, хакеры, вирусы...), но только не их код, который они "точно проверили на 100%". Однажды мне долго доказывали, что в неверной логике игры (!) шахматной программы виноват вирус, который заражает объектные файлы (формат .obj -- результат промежуточной компиляции Си-файлов).

Ну конечно, сломалось НЕЧТО ДРУГОЕ, НО ТОЛЬКО НЕ МОЙ КОД, да-да.

Ну наверное бывает 0.1% случаев, когда действительно виноват не мой код, но во всех остальных случаях, если говорить о стандартной библиотеке и о моём коде, который я написал в прошлом месяце, то практически всегда проблема в моём коде, который я написал в прошлом месяце :)

**4. Начните эксперименты.**

Сперва полностью осознайте ошибку: что вообще происходит? Что вы ожидаете в данном случае? Когда это происходит? Когда это не происходит? Затем примените своё понимание системы, чтобы предположить, что может быть сломано, и придумайте эксперименты, подтверждающие это.

Экспериментами могут быть временное изменение или удаление кода, вызовы API, попытка выполнения с новыми входными значениями, просмотр значений в логах и с помощью отладчика.

Делайте предположение ровно об одном аспекте того, что может происходить ("эта переменная имеет значение 42, а должна быть 24", "серверу отправлен неправильный запрос", "этот код вообще не выполняется"), потому что если вы попытаетесь проверять одновременно несколько предположений (так называемый многофакторный анализ), количество возможных вариантов проверок резко возрастёт, и вы только запутаетесь. Проведите эксперимент, чтобы проверить только одно это предположение за раз. Повторяйте эту схему, пока не поймете точно, что происходит.

Отладка очень часто приводит к осознанию того, что то, в чем вы были уверены ("подождите, этот запрос ведь идёт на новый сервер, а не на старый??"), на самом деле... не соответствует действительности. Вот некоторые распространенные классы неверных предположений:

- эта переменная имеет значение X ("это имя файла задано правильно")
- значение этой переменной никак не могло измениться от X к Y
- этот код раньше работал верно
- эта функция делает X
- я редактирую правильный файл
- после копирования похожего кода я исправил его верно
- в этой строке не может быть опечаток, это всего лишь 1 строка кода
- так написано в документации
- код, на который я смотрю, когда-то будет выполняться
- эти две части кода выполняются последовательно, а не параллельно
- код работает одинаково при компиляции в режиме debug и release

**5. Пишите код так, чтобы его было легко отлаживать.**

В частности, активнее применяйте [assert-ы](https://vk.com/wall-152484379_1758) и блоки try. Да, отлаживаемый код далеко не всегда получается "чистым", и когда в нём много проверок и обработчиков ошибок, читать его совсем не так приятно. Но очень важно, чтобы каждый раз, когда возникает ошибка, программа сообщала в понятной форме, что именно пошло не так, а также примерное место сбоя. Отсюда уже достаточно легко добраться до самого бага.

Лучше всего немедленно возвращать сообщение об ошибке и завершать работу приложения вместо того, чтобы продолжать молча использовать неправильные данные или передавать бессмысленное/нулевое значение другой функции, которая будет делать с ним неведомо что, и ошибка будет только расползаться, удаляясь всё дальше от своего источника. Далеко не во всех системах такое возможно, однако полезно как минимум немедленно сообщать об ошибке -- например, тимлиду.

**6. Учитывайте, что стандартные сообщения об ошибках часто сами по себе требуют понимания.**

Не экономьте на подробностях пойманной ошибки. Выводите в лог всю доступную информацию, в таком случае вам, возможно, даже не придётся отыскивать причину бага: о нём подробно будет сказано в сообщении. В частности, очень полезно сохранять в логе весь стек вызовов, приведших к сбою.

Однако нередко правильно интерпретировать сообщения об ошибках нелегко, потому что правильное понимание может подразумевать изучение новой концепцию. Например, сообщение "Ваш код использует переменную вне области видимости, в которой она определена" подразумевает ваше знание области видимости переменной. Подобная проблема характерна, в частности, для языков Go и Rust.

Кроме того, тоже довольно часто конечные сообщения об ошибках вызываются проблемами, сильно отличающимися от текста сообщения. Например, если сервер отключился, а такая ситуация в коде обрабатывается плохо (подробно разбираем этот момент на курсе по распределённым системам), то может возникнуть цепочка самых странных вызовов функций с непонятными аргументами.

Вдобавок, навык понимания сообщений об ошибках плохо передается при переходе, например, на новый язык или фреймворк, так что это определённо проблема не только начинающих программистов.

**7. Итог.**

Конечно, легко сказать "ну, вам нужно воспроизвести баг, затем уточнить это, затем начать придумывать догадки о возможной причине, и проверять их, затем разобраться в коде, пофиксить баг и, надеюсь, написать тест ". Но где мы действительно застреваем на практике? Какие шаги тут будут самыми трудными именно для вас? Рефлексируйте регулярно, фиксируйте время по каждому такому шагу, собирайте статистику. Скорее всего, вы будете сильно удивлены, на что именно уходит львиная доля времени в вашей отладке; подумайте, как соответствующий шаг можно оптимизировать.

Много технических приёмов отладки, о которых вы скорее всего не слышали, подробно рассматриваем на курсе Ясное Легаси.
