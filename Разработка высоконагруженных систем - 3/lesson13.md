## Сериализуемая изоляция снимков состояния

Проблема 41. Действующие реализации сериализуемости характеризуются низкой производительностью (двухфазная блокировка), или плохо масштабируются (последовательное выполнение). С другой стороны, слабые уровни изоляции показывают высокую производительность, но подвержены различным состояниям гонки (потеря обновлений, асимметрия записи, фантомы и т. д.). Возможно ли тут компромиссное решение?

Решение. **Сериализуемая изоляция снимков состояния** (serializable snapshot isolation, SSI) обеспечивает полную сериализуемость за счёт лишь небольшого снижения производительности по сравнению с обычной изоляцией снимков состояния, и применяется, например, в PostgreSQL.

## Сериализуемая изоляция снимков состояния

Двухфазная блокировка представляет собой так называемый механизм пессимистического управления конкурентным доступом: если что-то может потенциально пойти не так (о чём сигнализирует удерживаемая другой транзакцией блокировка), то лучше подождать нормализации ситуации, прежде чем выполнять какие-либо действия. Например, в многопоточном программировании для защиты данных применяют взаимоисключающие блокировки (mutual exclusion).

Последовательное выполнение предельно пессимистично: фактически, оно подразумевает, что каждая транзакция удерживает монопольную блокировку на всю базу данных (или всю секцию базы) на всё время своего выполнения. Пессимистичность компенсируется максимальным ускорением отдельных транзакций, поэтому блокировки приходится удерживать только короткий период времени (хотя и не всегда).

Сериализуемая изоляция снимков состояния представляет собой оптимистический метод управления конкурентным доступом: вместо блокировки в расчёте на потенциально опасные действия транзакции просто продолжают выполняться "в надежде", что всё будет хорошо. При фиксации транзакции база данных проверяет, не случилось ли что-то плохое (не была ли нарушена изоляция). Если выявлено нарушение, то транзакция прерывается, и её выполнение повторяется ещё раз. Допускается успешная фиксация транзакций, только выполненных подобным сериализуемым образом.

SSI основана на изоляции снимков состояния: все операции чтения в пределах транзакции выполняются на основе согласованного снимка состояния базы данных. SSI добавляет поверх изоляции снимков состояния алгоритм обнаружения конфликтов сериализации между операциями записи, который принимает решение, какие транзакции прервать.

## Сериализуемая изоляция снимков состояния

Проблема 42. Транзакция предпринимает какие-либо действия на основе определённых исходных условий. Но к моменту фиксации транзакции первоначальные данные могли поменяться, и исходные условия более не соответствуют действительности. Как быть?

Решение. Изоляция снимков состояния обычно реализуется с помощью многоверсионного управления конкурентным доступом MVCC. Транзакция, читающая из согласованного снимка состояния в базе данных MVCC, игнорирует все операции записи, которые были выполнены транзакциями, ещё не зафиксированными на момент получения этого снимка состояния. Соответственно, база данных отслеживает случаи игнорирования транзакцией операций записи других транзакций (по правилам видимости в MVCC). При попытке фиксации транзакции база проверяет, были ли зафиксированы какие-либо проигнорированные операции записи, и если да, то транзакцию необходимо прервать.

## Сериализуемая изоляция снимков состояния

Проблема 43. Транзакция модифицирует данные сразу/вскоре после их чтения другими транзакциями.

Решение. Блокировки по диапазону значений индекса позволяют базе данных блокировать доступ ко всем строкам, соответствующим некоему запросу на поиск (например "WHERE user_id = 12345"). Можно воспользоваться аналогичным методом и тут (с учётом того, что SSI не блокирует другие транзакции).

Транзакция, записывающая данные в базу, должна выполнить поиск по индексам всех остальных транзакций, которые недавно прочитали соответствующие данные. Вместо блокировки до момента фиксации транзакций, читающих эти данные, такая блокировка постфактум уведомляет транзакции, что прочитанные ими данные могут оказаться неактуальными.

Подобное детальное отслеживание действий каждой транзакции обеспечивает высокое качество принятия решений о прерывании транзакций, однако и издержки могут оказаться существенными. Менее детальное отслеживание будет работать быстрее, но способно привести к прерыванию лишних транзакций, которые, строго говоря, прерывать не было нужды.

### Предикатная блокировка (задания)

======= 39. Предикатная блокировка применима ... (выберите неверное утверждение)

[ 1] только к конкретному объекту базы

[ ] к группе объектов

[ ] к фантомам

======= 40. Блокировка по диапазону значений индекса -- это когда ...

[ 1] предикат упрощается, чтобы он соответствовал более широкому множеству объектов

[ ] предикат усиливается, чтобы он соответствовал более точному множеству объектов

======= 41. Сериализуемость обеспечивается ...

[ ] обычной блокировкой

[1 ] двухфазной блокировкой

[ ] предикатной блокировкой

[ ] блокировкой по диапазону значений

======= 42. Если транзакция модифицирует данные сразу/вскоре после их чтения другими транзакциями, надо применять ...

[ ] двухфазную блокировку

[ 1] поиск других транзакций и уведомление постфактум

[ ] прерывание других транзакций
