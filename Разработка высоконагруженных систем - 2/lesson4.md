## Синхронная и асинхронная репликация

Репликация на ведомый узел может происходить  **синхронно** : ведущий узел ждёт, пока ведомый узел не подтвердит получение операции записи, прежде чем сообщить пользователю об успехе, и сделать результаты записи видимыми другим клиентам. Копия данных на ведомом узле гарантированно актуальна и согласуется с ведущим узлом. В случае внезапного сбоя на ведущем узле можно быть уверенным, что данные по-прежнему доступны на ведомом узле.

Проблема 8. Иногда ведомые узлы сильно запаздывают по отношению к ведущим (на несколько минут): например, когда ведомый восстанавливается после отказа, когда система работает на пределе возможностей, когда между узлами возникают проблемы в работе сети. В таком случае ведущему узлу придется блокировать все другие запросы на запись и ждать, пока синхронная реплика не станет снова доступна. В результате сбой одного узла приведёт к замедлению или блокировке работы всей системы.

Решение. Организация  **асинхронной репликации на ведомый узел** : ведущий узел отправляет сообщение, но не ждёт ответа от ведомого.

## Синхронная и асинхронная репликация

На практике часто применяется  **полусинхронная (semi-synchronous) схема** , когда один из ведомых узлов синхронный, а остальные асинхронны. В случае замедления или недоступности синхронного ведомого узла таковым становится один из асинхронных ведомых узлов, что гарантирует наличие актуальной копии данных по крайней мере на двух узлах: ведущем и одном синхронном ведомом.

Проблема 9. Если запаздывают все ведомые узлы, ведущий узел теряет способность продуктивно выполнять операции записи.

Решение. Репликация с ведущим узлом делается  **полностью асинхронной** .

## Синхронная и асинхронная репликация

Проблема 10. При фатальном сбое ведущего узла все операции записи, ещё не реплицированные на ведомые узлы, теряются -- сохраняемость записи не гарантируется, даже если клиент получил подтверждение.

Решение. Для последних полу- и полностью асинхронных случаев применяются дополнительные технические меры, улучшающие общую надёжность: повышение количества ведомых узлов (с запасом от перегрузки), их географическое разделение, и т. п.

## Синхронная и асинхронная репликация

Проблема 11. Число ведомых узлов периодически приходится увеличивать: надо добавить новые реплики или заменять сбойные узлы. Как гарантировать, что новый ведомый узел будет содержать точную копию данных ведущего? Клиенты постоянно пишут данные в БД, и они постоянно меняются, поэтому при обычном копировании разные части БД будут скопированы в разные моменты времени, и результат окажется бессмысленным.

Обеспечить согласованность файлов на диске можно путем блокировки БД (сделав её недоступной для операций записи), но это вступает в противоречие с важным требованием обеспечения высокой доступности.

Решение. Алгоритм:

1. Сделать снимок состояния БД ведущего узла на некоторый момент времени (без блокировки всей базы), что обычно допускается в целях резервного копирования.
2. Скопировать снимок на новый ведомый узел.
3. Ведомый узел подключается к ведущему и запрашивает все изменения данных, произошедшие с момента создания снимка. Обычно для этого соотносят снимок с позицией в журнале репликации ведущего узла. Эта позиция в PostgreSQL называется регистрационным номером транзакции в журнале (log sequence number), в MySQL — координатами в бинарном журнале (binlog coordinates).
4. Когда ведомый узел завершит обработку изменений данных, произошедших с момента формирования снимка, он может продолжать работать в обычном режиме.

### Cинхронная и асинхронная репликация с ведущим узлом (задания)

======= 10. В синхронном режиме ...

[ ] ведущий узел не ждёт, когда ведомый узел подтвердит получение операции

[ 1] ведущий узел ждёт, когда ведомый узел подтвердит получение операции

======= 11. В асинхронном режиме ...

[1 ] ведущий узел не ждёт, когда ведомый узел подтвердит получение операции

[ ] ведущий узел ждёт, когда ведомый узел подтвердит получение операции

======= 12. При сбое ведущего узла все не реплицированные операции записи теряются ...

[ ] в синхронном режиме

[] в асинхронном режиме

[1] во всех режимах
