## Задержки репликации

Проблема 24. Пользователю часто разрешается редактировать почти всё в системе, поэтому предыдущий подход оказывается неэффективным: придётся почти всё читать с ведущего узла, что сведет на нет эффект от масштабирования по чтению.

Решение. Применять другие критерии маркирования данных, которые следует читать с ведущего узла. Например, можно отслеживать время последнего обновления данных, и в течение одной минуты читать всё с ведущего узла. Можно также следить за задержкой репликации на ведомые узлы и предотвращать выполнение запросов на любых узлах, запаздывающих по сравнению с ведущим более чем на минуту.

Время последней операции записи можно отслеживать на клиенте, тогда реплика, обслуживающая его операции чтения, может гарантировать, что она отражает изменения по состоянию на соответствующий момент времени. Если же реплика недостаточно актуальна, то можно делегировать операцию чтения другой реплике, или отложить выполнение запроса, пока реплика не синхронизируется с ведущим узлом.

## Задержки репликации

Проблема 25. Один и тот же пользователь может обращаться к сервису с разных устройств -- например из настольного браузера и мобильного приложения. Если пользователь вводит информацию на одном устройстве, а затем просматривает её с другого, то должен увидеть только что введенную информацию. В таком случае запоминать время последнего обновления на клиенте становится бессмысленно, поскольку выполняемый на одном клиентском устройстве код не знает про обновления на другом.

Решение. Реализуем согласованность "чтение после записи": соответствующие метаданные необходимо сосредоточить в одном месте на сервере.

## Задержки репликации

Проблема 26. При распределении реплик по нескольким ЦОДам (ради географической близости к пользователю) нет никаких гарантий, что подключения с разных устройств к ведущему узлу будут маршрутизированы в один ЦОД.

Решение. Запросы со всех устройств пользователя, подлежащие обслуживанию ведущим узлом, необходимо маршрутизировать на ЦОД, в котором находится этот узел.

## Задержки репликации

Проблема 27. Системы с конечной согласованностью могут работать стабильно, когда задержка репликации составляет секунды, однако когда она возрастает до нескольких минут или даже часов, пользователи начинают испытывать сильные неудобства.

Решение. В таких случаях нужно проектировать систему с более сильными гарантиями -- например, с поддержкой чтения после записи. Фактически, надо признать и исходить из того, что система по сути своей получается полностью асинхронной.

### Задержки репликации (задания)

======= 23. Если пользователю разрешается редактировать почти всё в сервисе, эффект от масштабирования по чтению теряется (выберите неверное решение)

[] отслеживать на клиенте время последней операции записи

[1] быстро читать всё с ведущего узла

[] отложить выполнение запроса до окончания синхронизации

[] делегировать операцию чтения другой реплике

======= 24. Если задержка возрастает до нескольких минут ...

[] сосредотачиваем метаданные на одном сервере

[1] проектируем систему полностью асинхронной

[] запоминаем время последнего обновления на клиенте
