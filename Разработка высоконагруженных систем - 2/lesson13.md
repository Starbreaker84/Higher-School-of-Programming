## Сходимость к согласованному состоянию

База данных с одним ведущим узлом применяет операции записи в последовательном порядке: при наличии нескольких изменений поля таблицы последняя по времени операция записи определяет итоговое значение этого поля.

Проблема 38. В схеме с несколькими ведущими узлами нельзя задать порядок операций записи, и непонятно, каким должно быть итоговое значение поля. Если все реплики будут просто применять операции записи в том порядке, в котором они эти операции записи получают, то база данных в конце концов окажется в несогласованном состоянии: в разных ведущих узлах итоговое значение одного и того же поля окажется различным, что недопустимо. Каждая схема репликации обязана обеспечить наличие одинаковых данных во всех репликах. СУБД должна разрешать конфликт конвергентным способом: все реплики должны сойтись к одному значению после репликации всех изменений.

Решение. Существует несколько способов конвергентного разрешения конфликтов.

Каждой операции записи присваивается уникальный идентификатор (например, метка даты/времени, случайное длинное число, UUID, хеш ключа и значения и т. п.). Остаётся просто выбрать операцию-победитель с максимальным значением этого идентификатора, а остальные отбросить. Подобная схема называется  **"выигрывает последний" (last write wins, LWW)** .

## Сходимость к согласованному состоянию

Проблема 39. Хотя подход LWW очень популярен, ему свойственно терять данные.

Решение. Каждой реплике присваивается уникальный идентификатор (номер), и считается, что у операций записи, исходящих от реплик с большим номером, есть приоритет перед теми, которые исходят от реплик с меньшим номером.

## Сходимость к согласованному состоянию

Проблема 40. К сожалению, подход с нумерованием реплик также приводит к потерям данных.

Решение. Найти хороший технический способ (под конкретный проект) объединить значения воедино -- например, выстроить их в алфавитном порядке, после чего выполнить их конкатенацию.

## Сходимость к согласованному состоянию

Проблема 41. Что считать конфликтом, в общем случае? Некоторые разновидности конфликтов очевидны. Например, две операции записи "одновременно" меняют значение одного поля одной записи различным образом.

Решение (не только для данного случая, а и для многих других). Заносить конфликты в явно заданную в системе структуру данных для хранения, и написать прикладной код, который бы разрешал конфликты позднее (в частности, запрашивая для этого ручные действия пользователя или системного администратора).



### Сходимость к согласованному состоянию (задания)

======= 33. В схеме с несколькими ведущими узлами нельзя задать порядок операций записи ...

[ ] на всех репликах применяем операции записи в том порядке, в котором они поступают

[ ] придерживаемся схемы "выигрывает первый"

[ 1] придерживаемся схемы "выигрывает последний"

======= 34. Как лучше обрабатывать конфликты?

[ ] вручную

[ 1] автоматизацией учёта и обработки конфликтов

[ ] нумерацией реплик
