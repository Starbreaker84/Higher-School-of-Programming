## 49. Ленивые последовательности

**49.1. Последовательности**

Последовательность -- это (возможно, бесконечная) упорядоченная коллекция элементов, значения которых вычисляются лишь в момент обращения к ним.

За счёт отложенных (ленивых) вычислений последовательностей можно представлять бесконечные последовательности, так как не требуется сразу вычислять их полностью.

Тип последовательности seq<'a> .

Реализация последовательностей поддерживается библиотекой Seq.

Конечная последовательность задаётся аналогично списку.

```
let sq = seq [1; 2; 3]
```

Бесконечная последовательность задаётся стандартной функцией Seq.initInfinite, параметр которой -- функция, генерирующая последовательные значения.

Например, бесконечная последовательность квадратов целых чисел, начиная с нуля:

```
let sqr = Seq.initInfinite (fun i -> i*i)
```

Стандартная функция Seq.nth (в новых версиях компилятора F# -- Seq.item) вычисляет n-й элемент последовательности.

```
Seq.nth 5 sqr = 25 // true
```

**49.2. Кэшированные последовательности**

Seq.nth каждый раз перевычисляет запрошенный элемент заново, и если вычисления нагрузочные, а обращений к элементам последовательности много, лучше использовать кэшированные последовательности, которые хранят первые n вычисленных элементов.

Функция Seq.cache вызывается дополнительно после создания последовательности с помощью Seq.initInfinite, и формирует кэшированную последовательность.

```
let sqr = Seq.initInfinite (fun i -> i*i)
let sqr_cache = Seq.cache sqr
```

При вычислении n-го элемента кэшированной последовательности вычисляются также все предыдущие её элементы, если они ещё не были вычислены.

```
Seq.nth 3 sqr_cache // вычислены элементы 0,1,2,3
Seq.nth 5 sqr_cache // вычислены элементы 4,5
Seq.nth 4 sqr_cache // ничего не вычисляется, сразу возвращается 4-й элемент 16
```

**49.3. Стандартные операции над последовательностями**

Пустая последовательность обозначается Seq.empty.

Одноэлементная последовательность (синглетон) создаётся с помощью функции Seq.singleton.

```
let sq = Seq.singleton "123"
```

Функция Seq.ofList формирует последовательность из списка.

```
let sq = Seq.ofList [1; 2; 4]
```

Функция Seq.toList преобразует последовательность в список.

Функция Seq.init формирует n элементов конечной последовательности, получая параметром количеств элементов и функцию генерации.

```
let sq = Seq.init 3 (fun i -> (i+i, string i)) // [(0,"0"), (2, "1"), (4, "2")]
```

Функция Seq.append "сцепляет" две последовательности.

```
let sq = Seq.append (seq [1;2;3]) (seq [5;6])
```

**49.4. Задания**

49.5.1. Определите последовательность чётных положительных чисел.

49.5.2. Определите последовательность факториалов неотрицательных целых чисел 1,1,2,6,...,n!

49.5.3. Определите последовательность 0, -1, 1, -2, 2, -3, 3, ...

Шаблон для отправки на сервер:

```
// 49.5.1
let even_seq = ...

// 49.5.2
let fac_seq = ...

// 49.5.3
let seq_seq = ...
```

**[[ предыдущее ]](https://skillsmart.ru/fp/fsh/g7b1efcb2e.html)**

---

**Ответы на задания 48**

```
let rec fib1 n n1 n2 = 
    match n with
    | 0 -> n2
    | 1 -> n1
    | n -> fib1 (n - 1) (n1 + n2) n1

let rec fib2 n c = 
    match n with
    | 0 -> c 0
    | 1 -> c 1
    | n -> fib2 (n - 2) (fun a -> fib2 (n - 1) (fun b -> c (a + b)))

let rec bigList n k =
  if n = 0 then k []
  else bigList (n - 1) (fun res -> k(1::res))
```
