## Изоляция и сбои

Изоляция в смысле ACID означает, что **одновременно выполняемые транзакции изолированы друг от друга** и никак не могут помешать друг другу.

Проблема 8. Классические учебники по базам данных нередко понимают под изоляцией **сериализуемость** (serializability) -- более сильное требование, когда каждая транзакция выполняется так, словно она единственная. СУБД гарантирует, что результат фиксации транзакций будет такой же, как если бы они выполнялись последовательно, хотя в реальности они могут выполняться одновременно (каузальный порядок вычислений мы изучали в параллельной декларативной модели).

Решение. Подразумевается, что другие транзакции видят либо все применённые другими транзакциями результаты операций записи, либо никакие. Однако на практике сериализуемые транзакции используются редко, поскольку влекут за собой проблемы с производительностью.

## Изоляция и сбои

Проблема 9. В случае отказа аппаратного обеспечения или фатального сбоя самой СУБД потенциально могут теряться результаты даже успешно зафиксированных транзакций.

Решение. **Сохраняемость** -- обязательство СУБД не терять уже записанных транзакций ни при каких условиях. Она подразумевает как минимум запись данных на энергонезависимый носитель информации (жёсткий диск или SSD), а дополнительно ведётся например журнал упреждающей записи, обеспечивающий возможность восстановления в случае повреждения структур данных на диске.

В реплицируемой БД сохраняемость может означать например, что данные были успешно скопированы на заданное число узлов.

Для обеспечения гарантии сохраняемости СУБД должна дождаться полного завершения операций записи или репликаций, прежде чем сообщать об успешной фиксации транзакции.

В целом же, конечно, абсолютная надежность недостижима: например, все жёсткие диски и резервные копии могут быть уничтожены одновременно.

## Изоляция и сбои

Проблема 10. Если в одной транзакции выполняется несколько операций записи, то с большой вероятностью одновременно модифицируется несколько объектов (строк таблиц, документов...). Как СУБД понять, что такие разные операции относятся к одной транзакции?

Решение. Непосредственно внутри кода SQL транзакция выделяется ключевыми словами BEGIN TRANSACTION и COMMIT, и СУБД отслеживает, как группировать команды внутри такой явной транзакции по их конкретному сетевому соединению. Однако в NoSQL-системах обычно такие группировки операций не поддерживаются.

## Изоляция и сбои

Проблема 11. Когда в базу данных записывается, например, JSON-документ, и случается разрыв сетевого соединения при передаче первой половины документа, или сбой питания посередине перезаписи базой данных предыдущего значения, что увидит другой клиент, читающий данный документ во время операции записи, которая прервалась?

Решение. При выполнении подобных **однообъектных операций** СУБД обычно всегда применяют атомарность и изоляцию. Однако их нельзя назвать транзакциями в обычном смысле этого слова. Они называются по разному: "облегчённые операции", "поддержка ACID" и т. п. Под транзакцией понимается прежде всего механизм группировки нескольких операций над несколькими объектами в одну логическую и физическую единицу выполнения.

### Транзакции и ACID (задания)

======= 4. Атомарность -- это ...

[1] возможность прервать транзакцию при внешней ошибке

[] невозможность разбиения на меньшие части

[] корректная фиксация всех изменений

======= 5. Система считается консистентной, когда ...

[] согласованность сохраняется после выполнения всей транзакции

[] транзакция стартует в справедливом состоянии базы данных

[1] инварианты после любой операции записи остаются истинными

======= 6. Поддержка инвариантов - это ...

[ ] обязанность СУБД

[ 1] обязанность прикладной системы

[ ] обязанность программиста

======= 7. Что фактически лишнее в ACID?

[ ] атомарность

[ 1] согласованность

[ ] изоляция

[ ] сохраняемость
